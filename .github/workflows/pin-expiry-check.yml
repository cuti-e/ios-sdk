name: Certificate Pin Expiry Check

on:
  schedule:
    # Run monthly on the 1st at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-expiry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check certificate pin expiry
        id: expiry-check
        run: |
          # Certificate pins expire June 22, 2036
          EXPIRY_DATE="2036-06-22"
          EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
          NOW_EPOCH=$(date +%s)
          DAYS_UNTIL=$(( (EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))

          echo "days_until=$DAYS_UNTIL" >> $GITHUB_OUTPUT

          if [ $DAYS_UNTIL -lt 0 ]; then
            echo "::error::Certificate pins have EXPIRED! Immediate action required."
            exit 1
          elif [ $DAYS_UNTIL -lt 365 ]; then
            echo "::warning::Certificate pins expire in $DAYS_UNTIL days. Plan SDK update."
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "Certificate pins valid for $DAYS_UNTIL more days (expires $EXPIRY_DATE)"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if expiring within 1 year
        if: steps.expiry-check.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const daysUntil = ${{ steps.expiry-check.outputs.days_until }};
            const title = `Certificate pins expiring in ${daysUntil} days`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,certificate-pinning'
            });

            const existingIssue = issues.data.find(i => i.title.includes('Certificate pins expiring'));

            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              // Update the existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Monthly check: Certificate pins expire in **${daysUntil} days** (June 22, 2036).`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: `## Certificate Pin Expiry Warning

The SSL certificate pins in this SDK will expire on **June 22, 2036**.

**Days remaining:** ${daysUntil}

### Action Required

1. Identify the new root CA certificates from Cloudflare/Google Trust Services
2. Extract SPKI SHA-256 hashes for the new certificates
3. Update \`CutiECertificatePinning.swift\` with new hashes
4. Test thoroughly on sandbox API
5. Release new SDK version
6. Notify all SDK users to update

### Resources

- [CERTIFICATE_PINNING.md](./CERTIFICATE_PINNING.md) - Update process documentation
- [Google Trust Services](https://pki.goog/) - Root CA information

This issue was automatically created by the monthly certificate expiry check.`,
                labels: ['security', 'certificate-pinning', 'urgent']
              });
            }
