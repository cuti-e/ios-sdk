name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    tags: ['*']

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: [self-hosted, macOS, ios]
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build for iOS
        run: |
          xcodebuild build \
            -scheme CutiE \
            -destination 'generic/platform=iOS Simulator' \
            -skipPackagePluginValidation

      - name: Build for macOS
        run: |
          xcodebuild build \
            -scheme CutiE \
            -destination 'platform=macOS'

  test:
    name: Test with Coverage
    runs-on: [self-hosted, macOS, ios]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Run Tests with Coverage
        run: |
          xcodebuild test \
            -scheme CutiE \
            -destination 'platform=macOS' \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            -skipPackagePluginValidation

      - name: Extract Coverage Report
        run: |
          # Extract coverage percentage
          xcrun xccov view --report --only-targets TestResults.xcresult > coverage_report.txt
          cat coverage_report.txt

          # Extract overall coverage for CutiE target (not CutiETests)
          COVERAGE=$(xcrun xccov view --report --only-targets TestResults.xcresult | grep -E '^[0-9]+\s+CutiE\s' | awk '{print $(NF-1)}')
          echo "## Code Coverage: $COVERAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage by File" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          xcrun xccov view --report TestResults.xcresult --files-for-target 'CutiE' >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check Coverage Threshold
        run: |
          # Extract coverage percentage (e.g., "11.31%" -> "11.31")
          COVERAGE=$(xcrun xccov view --report --only-targets TestResults.xcresult | grep -E '^[0-9]+\s+CutiE\s' | awk '{print $(NF-1)}' | tr -d '%')
          echo "Coverage: ${COVERAGE}%"

          # Warn if coverage is below 30% (informational, not blocking)
          if [ -n "$COVERAGE" ]; then
            COVERAGE_INT=${COVERAGE%.*}
            if [ "$COVERAGE_INT" -lt 30 ]; then
              echo "::warning::Code coverage is below 30% (${COVERAGE}%). Consider adding more tests."
            fi
          fi

  docs:
    name: Build Documentation
    runs-on: [self-hosted, macOS, ios]
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build DocC Documentation
        run: |
          xcodebuild docbuild \
            -scheme CutiE \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath .build

      # Note: Upload disabled - DocC generates filenames with colons (Swift function signatures)
      # which are invalid on Windows/NTFS and rejected by actions/upload-artifact
